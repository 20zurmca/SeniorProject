--Entire Job


--Create tables for roster data aggregation and copy in data

\COPY map_rosterdata FROM 'roster_data.csv' DELIMITER ',' CSV HEADER;

\COPY map_starterdata FROM 'starter_data.csv' DELIMITER ',' CSV HEADER;

\COPY map_accoladedata FROM 'accolades.csv' DELIMITER ',' CSV HEADER;


--Create table for high school data and copy in the data

CREATE TABLE high_school_data (City VARCHAR(30), Institution VARCHAR(100), "State/Province" VARCHAR(20), Country VARCHAR(50), Latitude DOUBLE PRECISION, Longitude DOUBLE PRECISION, school_type VARCHAR(20));

\COPY high_school_data FROM 'high_school_data.csv' DELIMITER ',' CSV HEADER;

UPDATE high_school_data SET Institution = LOWER(Institution);


--Join with starter data

CREATE TABLE roster_starter_data AS (
	SELECT map_rosterdata.Roster_Year, map_rosterdata.Player_Number, map_rosterdata.First_Name, map_rosterdata.Last_Name, map_rosterdata.Year, map_rosterdata.Position1, map_rosterdata.Position2, map_rosterdata.Position3, map_rosterdata.Height, map_rosterdata.Weight, map_rosterdata.Home_Town, map_rosterdata.State_or_Country, map_rosterdata.High_School, map_rosterdata.Alternative_School, map_rosterdata.College, map_rosterdata.College_League, map_rosterdata.Bio_Link, map_starterdata.Potential_Starts, map_starterdata.GP, map_starterdata.GS, map_starterdata.Is_Starter
	FROM map_rosterdata
	LEFT JOIN map_starterdata
	ON map_rosterdata.First_Name=map_starterdata.First_Name AND map_rosterdata.Last_Name=map_starterdata.Last_Name AND map_rosterdata.Roster_Year=map_starterdata.Roster_Year AND map_rosterdata.College=map_starterdata.College
);


--Join with accolade data

CREATE TABLE roster_master_data AS (
	SELECT roster_starter_data.Roster_Year, roster_starter_data.Player_Number, roster_starter_data.First_Name, roster_starter_data.Last_Name, roster_starter_data.Year, roster_starter_data.Position1, roster_starter_data.Position2, roster_starter_data.Position3, roster_starter_data.Height, roster_starter_data.Weight, roster_starter_data.Home_Town, roster_starter_data.State_or_Country, roster_starter_data.High_School, roster_starter_data.Alternative_School, roster_starter_data.College, roster_starter_data.College_League, roster_starter_data.Bio_Link, roster_starter_data.Potential_Starts, roster_starter_data.GP, roster_starter_data.GS, roster_starter_data.Is_Starter, map_accoladedata.Accolade
	FROM roster_starter_data
	LEFT JOIN map_accoladedata
	ON roster_starter_data.First_Name=map_accoladedata.First_Name AND roster_starter_data.Last_Name=map_accoladedata.Last_Name AND roster_starter_data.Roster_Year=map_accoladedata.Roster_Year AND roster_starter_data.College=map_accoladedata.College
);


--Delete rows from original tables and the extra table
DELETE FROM map_rosterdata;
DELETE FROM map_starterdata;
DELETE FROM map_accoladedata;
DROP TABLE roster_starter_data;


--Drop unneeded columns
ALTER TABLE roster_master_data DROP COLUMN Position2;
ALTER TABLE roster_master_data DROP COLUMN Position3;
ALTER TABLE roster_master_data DROP COLUMN Potential_Starts;
ALTER TABLE roster_master_data DROP COLUMN GP;
ALTER TABLE roster_master_data DROP COLUMN GS;


-- Drop those entires with a null high school and alternative school

DELETE FROM roster_master_data
WHERE High_School IS NULL AND Alternative_School IS NULL;


-- Matching Operations

--Guaranteed matched Public School data

CREATE TABLE roster_public_school1 AS (
	SELECT *
	FROM roster_master_data
	JOIN high_school_data
	ON high_school_data.school_type = 'PUBLIC' AND (
		LOWER(roster_master_data.High_School) = LOWER(high_school_data.Institution)
	) AND (
		LOWER(high_school_data."State/Province") = LOWER(roster_master_data.State_or_Country)
	)
);

DELETE FROM roster_public_school1
USING (
	SELECT Institution, "State/Province", COUNT(Institution)
	FROM high_school_data
	GROUP BY Institution, "State/Province"
	HAVING high_school_data.count > 1
) AS temp1
WHERE LOWER(roster_public_school1.Institution) = LOWER(temp1.Institution) AND LOWER(roster_public_school1."State/Province") = LOWER(temp1."State/Province")
;

CREATE TABLE roster_public_school2 AS (
	SELECT *
	FROM roster_master_data
	JOIN high_school_data
	ON high_school_data.school_type = 'PUBLIC' AND (
		LOWER(roster_master_data.High_School) = LOWER(high_school_data.Institution)
	) AND (
		LOWER(high_school_data."State/Province") = LOWER(roster_master_data.State_or_Country)
	) AND (
		LOWER(roster_master_data.Home_Town) = LOWER(high_school_data.City)
	)
);

CREATE TABLE roster_public_final AS (
	SELECT *
	FROM roster_public_school1
	UNION
	SELECT *
	FROM
	roster_public_school2
);


DROP TABLE roster_public_school1;
DROP TABLE roster_public_school2;


--Guaranteed matched International School data

CREATE TABLE roster_international_school1 AS (
	SELECT *
	FROM roster_master_data
	JOIN high_school_data
	ON high_school_data.school_type = 'INTERNATIONAL' AND (
		LOWER(roster_master_data.High_School) = LOWER(high_school_data.Institution)
	) AND (
		LOWER(high_school_data.Country) = LOWER(roster_master_data.State_or_Country)
	)
);

DELETE FROM roster_international_school1
USING (
	SELECT Institution, Country, COUNT(Institution)
	FROM high_school_data
	GROUP BY Institution, Country
	HAVING high_school_data.count > 1
) AS temp1
WHERE LOWER(roster_international_school1.Institution) = LOWER(temp1.Institution) AND LOWER(roster_international_school1.Country) = LOWER(temp1.Country)
;

CREATE TABLE roster_international_school2 AS (
	SELECT *
	FROM roster_master_data
	JOIN high_school_data
	ON high_school_data.school_type = 'INTERNATIONAL' AND (
		LOWER(roster_master_data.High_School) = LOWER(high_school_data.Institution)
	) AND (
		LOWER(high_school_data.Country) = LOWER(roster_master_data.State_or_Country)
	) AND (
		LOWER(roster_master_data.Home_Town) = LOWER(high_school_data.City)
	)
);

CREATE TABLE roster_international_final AS (
	SELECT *
	FROM roster_international_school1
	UNION
	SELECT *
	FROM
	roster_international_school2
);


DROP TABLE roster_international_school1;
DROP TABLE roster_international_school2;


-- Unique School Names

CREATE TABLE roster_unique_final AS (
	SELECT *
	FROM roster_master_data
	JOIN high_school_data
	ON LOWER(roster_master_data.High_School) = LOWER(high_school_data.Institution) AND (LOWER(high_school_data."State/Province") = LOWER(roster_master_data.State_or_Country)
	OR LOWER(high_school_data.Country) = LOWER(roster_master_data.State_or_Country))
);

DELETE FROM roster_unique_final
USING (
	SELECT Institution, COUNT(Institution)
	FROM high_school_data
	GROUP BY Institution
	HAVING high_school_data.count > 1
) AS temp1
WHERE LOWER(roster_unique_final.Institution) = LOWER(temp1.Institution)
;


-- Union all tables

CREATE TABLE highschool_match_master AS (
	SELECT *
	FROM roster_unique_final
	UNION
	SELECT *
	FROM (
		SELECT *
		FROM roster_public_final
		UNION
		SELECT *
		FROM roster_international_final
	) AS temp1
);

-- Drop all extra tables
DROP TABLE roster_public_final;
DROP TABLE roster_international_final;
DROP TABLE roster_unique_final;
DROP TABLE roster_master_data;


-- Group entries


CREATE TABLE grouped_data_temp AS (
	select first_name, last_name, home_town, state_or_country, high_school, alternative_school, college, college_league, MAX(city) AS highSchoolCity, MAX("State/Province") AS highSchoolStateOrProvince, MAX(country) AS highSchoolCountry, MAX(school_type) AS school_type, COUNT(is_starter = 'Y') AS starter_count, COUNT(accolade) AS accolade_count, MAX(latitude) AS latitude, MAX(longitude) AS longitude, ARRAY_AGG(roster_year) AS roster_year, ARRAY_AGG(year) AS year, ARRAY_AGG(position1) AS position, ARRAY_AGG(height) AS height, ARRAY_AGG(weight) AS weight, ARRAY_AGG(bio_link) AS bio_link
	FROM highschool_match_master
	GROUP BY first_name, last_name, home_town, state_or_country, high_school, alternative_school, college, college_league
);

-- add id to new table and clear old table
ALTER TABLE grouped_data_temp ADD COLUMN id SERIAL PRIMARY KEY;

CREATE TABLE grouped_data AS (
	select id, first_name, last_name, home_town, state_or_country, high_school, alternative_school, college, college_league, highSchoolCity, highSchoolStateOrProvince, highSchoolCountry, school_type, starter_count, accolade_count, latitude, longitude, roster_year, year, position, height, weight, bio_link
	FROM grouped_data_temp
);

DROP TABLE grouped_data_temp;


DELETE FROM map_groupeddata;

INSERT INTO map_groupeddata
	SELECT *
	FROM grouped_data
;

-- drop old table
DROP TABLE grouped_data;


-- Table and trigger for document tracking

-- CREATE TABLE documents (id SERIAL PRIMARY KEY, description VARCHAR(255), document VARCHAR(50), uploaded_at TIMESTAMP);

CREATE OR REPLACE FUNCTION update_db_func() RETURNS TRIGGER AS $$
	BEGIN

		--Join with starter data

		CREATE TABLE roster_starter_data AS (
			SELECT map_rosterdata.Roster_Year, map_rosterdata.Player_Number, map_rosterdata.First_Name, map_rosterdata.Last_Name, map_rosterdata.Year, map_rosterdata.Position1, map_rosterdata.Position2, map_rosterdata.Position3, map_rosterdata.Height, map_rosterdata.Weight, map_rosterdata.Home_Town, map_rosterdata.State_or_Country, map_rosterdata.High_School, map_rosterdata.Alternative_School, map_rosterdata.College, map_rosterdata.College_League, map_rosterdata.Bio_Link, map_starterdata.Potential_Starts, map_starterdata.GP, map_starterdata.GS, map_starterdata.Is_Starter
			FROM map_rosterdata
			LEFT JOIN map_starterdata
			ON map_rosterdata.First_Name=map_starterdata.First_Name AND map_rosterdata.Last_Name=map_starterdata.Last_Name AND map_rosterdata.Roster_Year=map_starterdata.Roster_Year AND map_rosterdata.College=map_starterdata.College
		);


		--Join with accolade data

		CREATE TABLE roster_master_data AS (
			SELECT roster_starter_data.Roster_Year, roster_starter_data.Player_Number, roster_starter_data.First_Name, roster_starter_data.Last_Name, roster_starter_data.Year, roster_starter_data.Position1, roster_starter_data.Position2, roster_starter_data.Position3, roster_starter_data.Height, roster_starter_data.Weight, roster_starter_data.Home_Town, roster_starter_data.State_or_Country, roster_starter_data.High_School, roster_starter_data.Alternative_School, roster_starter_data.College, roster_starter_data.College_League, roster_starter_data.Bio_Link, roster_starter_data.Potential_Starts, roster_starter_data.GP, roster_starter_data.GS, roster_starter_data.Is_Starter, map_accoladedata.Accolade
			FROM roster_starter_data
			LEFT JOIN map_accoladedata
			ON roster_starter_data.First_Name=map_accoladedata.First_Name AND roster_starter_data.Last_Name=map_accoladedata.Last_Name AND roster_starter_data.Roster_Year=map_accoladedata.Roster_Year AND roster_starter_data.College=map_accoladedata.College
		);


		--Delete rows from original tables and the extra table
		DELETE FROM map_rosterdata;
		DELETE FROM map_starterdata;
		DELETE FROM map_accoladedata;
		DROP TABLE roster_starter_data;


		--Drop unneeded columns
		ALTER TABLE roster_master_data DROP COLUMN Position2;
		ALTER TABLE roster_master_data DROP COLUMN Position3;
		ALTER TABLE roster_master_data DROP COLUMN Potential_Starts;
		ALTER TABLE roster_master_data DROP COLUMN GP;
		ALTER TABLE roster_master_data DROP COLUMN GS;


		-- Drop those entires with a null high school and alternative school

		DELETE FROM roster_master_data
		WHERE High_School IS NULL AND Alternative_School IS NULL;


		-- Matching Operations
		--Guaranteed matched Public School data

		CREATE TABLE roster_public_school1 AS (
			SELECT *
			FROM roster_master_data
			JOIN high_school_data
			ON high_school_data.school_type = 'PUBLIC' AND (
				LOWER(roster_master_data.High_School) = LOWER(high_school_data.Institution)
			) AND (
				LOWER(high_school_data."State/Province") = LOWER(roster_master_data.State_or_Country)
			)
		);

		DELETE FROM roster_public_school1
		USING (
			SELECT Institution, "State/Province", COUNT(Institution)
			FROM high_school_data
			GROUP BY Institution, "State/Province"
			HAVING high_school_data.count > 1
		) AS temp1
		WHERE LOWER(roster_public_school1.Institution) = LOWER(temp1.Institution) AND LOWER(roster_public_school1."State/Province") = LOWER(temp1."State/Province")
		;

		CREATE TABLE roster_public_school2 AS (
			SELECT *
			FROM roster_master_data
			JOIN high_school_data
			ON high_school_data.school_type = 'PUBLIC' AND (
				LOWER(roster_master_data.High_School) = LOWER(high_school_data.Institution)
			) AND (
				LOWER(high_school_data."State/Province") = LOWER(roster_master_data.State_or_Country)
			) AND (
				LOWER(roster_master_data.Home_Town) = LOWER(high_school_data.City)
			)
		);

		CREATE TABLE roster_public_final AS (
			SELECT *
			FROM roster_public_school1
			UNION
			SELECT *
			FROM
			roster_public_school2
		);

		DROP TABLE roster_public_school1;
		DROP TABLE roster_public_school2;


		--Guaranteed matched International School data

		CREATE TABLE roster_international_school1 AS (
			SELECT *
			FROM roster_master_data
			JOIN high_school_data
			ON high_school_data.school_type = 'INTERNATIONAL' AND (
				LOWER(roster_master_data.High_School) = LOWER(high_school_data.Institution)
			) AND (
				LOWER(high_school_data.Country) = LOWER(roster_master_data.State_or_Country)
			)
		);

		DELETE FROM roster_international_school1
		USING (
			SELECT Institution, Country, COUNT(Institution)
			FROM high_school_data
			GROUP BY Institution, Country
			HAVING high_school_data.count > 1
		) AS temp1
		WHERE LOWER(roster_international_school1.Institution) = LOWER(temp1.Institution) AND LOWER(roster_international_school1.Country) = LOWER(temp1.Country)
		;

		CREATE TABLE roster_international_school2 AS (
			SELECT *
			FROM roster_master_data
			JOIN high_school_data
			ON high_school_data.school_type = 'INTERNATIONAL' AND (
				LOWER(roster_master_data.High_School) = LOWER(high_school_data.Institution)
			) AND (
				LOWER(high_school_data.Country) = LOWER(roster_master_data.State_or_Country)
			) AND (
				LOWER(roster_master_data.Home_Town) = LOWER(high_school_data.City)
			)
		);

		CREATE TABLE roster_international_final AS (
			SELECT *
			FROM roster_international_school1
			UNION
			SELECT *
			FROM
			roster_international_school2
		);


		DROP TABLE roster_international_school1;
		DROP TABLE roster_international_school2;


		-- Unique School Names

		CREATE TABLE roster_unique_final AS (
			SELECT *
			FROM roster_master_data
			JOIN high_school_data
			ON LOWER(roster_master_data.High_School) = LOWER(high_school_data.Institution) AND (LOWER(high_school_data."State/Province") = LOWER(roster_master_data.State_or_Country)
			OR LOWER(high_school_data.Country) = LOWER(roster_master_data.State_or_Country))
		);

		DELETE FROM roster_unique_final
		USING (
			SELECT Institution, COUNT(Institution)
			FROM high_school_data
			GROUP BY Institution
			HAVING high_school_data.count > 1
		) AS temp1
		WHERE LOWER(roster_unique_final.Institution) = LOWER(temp1.Institution)
		;


		-- Union all tables
		CREATE TABLE new_highschool_match_master AS (
			SELECT *
			FROM roster_unique_final
			UNION
			SELECT *
			FROM (
				SELECT *
				FROM roster_public_final
				UNION
				SELECT *
				FROM roster_international_final
			) AS temp1
		);

		-- Drop all extra tables
		DROP TABLE roster_public_final;
		DROP TABLE roster_international_final;
		DROP TABLE roster_unique_final;
		DROP TABLE roster_master_data;


		-- Union the new and old high school match master data

		CREATE TABLE highschool_match_master3 AS (
			SELECT *
			FROM highschool_match_master
			UNION
			SELECT *
			FROM new_highschool_match_master
		);

		-- Drop old and new table but not the combined one (3)
		DROP TABLE highschool_match_master;
		DROP TABLE new_highschool_match_master;

		ALTER TABLE highschool_match_master3 RENAME TO highschool_match_master;


		-- Group entries

		CREATE TABLE grouped_data_temp AS (
			select first_name, last_name, home_town, state_or_country, high_school, alternative_school, college, college_league, MAX(city) AS highSchoolCity, MAX("State/Province") AS highSchoolStateOrProvince, MAX(country) AS highSchoolCountry, MAX(school_type) AS school_type, COUNT(is_starter = 'Y') AS starter_count, COUNT(accolade) AS accolade_count, MAX(latitude) AS latitude, MAX(longitude) AS longitude, ARRAY_AGG(roster_year) AS roster_year, ARRAY_AGG(year) AS year, ARRAY_AGG(position1) AS position, ARRAY_AGG(height) AS height, ARRAY_AGG(weight) AS weight, ARRAY_AGG(bio_link) AS bio_link
			FROM highschool_match_master
			GROUP BY first_name, last_name, home_town, state_or_country, high_school, alternative_school, college, college_league
		);

		-- add id to new table and clear old table
		ALTER TABLE grouped_data_temp ADD COLUMN id SERIAL PRIMARY KEY;

		CREATE TABLE grouped_data AS (
			select id, first_name, last_name, home_town, state_or_country, high_school, alternative_school, college, college_league, highSchoolCity, highSchoolStateOrProvince, highSchoolCountry, school_type, starter_count, accolade_count, latitude, longitude, roster_year, year, position, height, weight, bio_link
			FROM grouped_data_temp
		);

		DROP TABLE grouped_data_temp;


		DELETE FROM map_groupeddata;

		INSERT INTO map_groupeddata
			SELECT *
			FROM grouped_data
		;

		-- drop old table
		DROP TABLE grouped_data;

		RETURN NEW;
	END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER update_db AFTER INSERT ON map_documents FOR EACH ROW EXECUTE PROCEDURE update_db_func();


-- \Copy map_groupeddata to 'grouped_data.csv' DELIMITER ',' CSV HEADER;
