-- Matching Operations

--Guaranteed matched Public School data

CREATE TABLE roster_public_school1 AS (
	SELECT *
	FROM roster_master_data
	JOIN high_school_data
	ON high_school_data."Public/Private/International" = 'PUBLIC' AND (
		LOWER(roster_master_data.High_School) = LOWER(high_school_data.Institution)
	) AND (
		LOWER(high_school_data."State/Province") = LOWER(roster_master_data.State_or_Country)
	)
);

DELETE FROM roster_public_school1
USING (
	SELECT Institution, "State/Province", COUNT(Institution)
	FROM high_school_data
	GROUP BY Institution, "State/Province"
	HAVING high_school_data.count > 1
) AS temp1
WHERE LOWER(roster_public_school1.Institution) = LOWER(temp1.Institution) AND LOWER(roster_public_school1."State/Province") = LOWER(temp1."State/Province")
;

CREATE TABLE roster_public_school2 AS (
	SELECT *
	FROM roster_master_data
	JOIN high_school_data
	ON high_school_data."Public/Private/International" = 'PUBLIC' AND (
		LOWER(roster_master_data.High_School) = LOWER(high_school_data.Institution)
	) AND (
		LOWER(high_school_data."State/Province") = LOWER(roster_master_data.State_or_Country)
	) AND (
		LOWER(roster_master_data.Home_Town) = LOWER(high_school_data.City)
	)
);

CREATE TABLE roster_public_final AS (
	SELECT *
	FROM roster_public_school1
	UNION
	SELECT *
	FROM
	roster_public_school2
);

-- \Copy roster_public_final to 'roster_public_final.csv' DELIMITER ',' CSV HEADER;

DROP TABLE roster_public_school1;
DROP TABLE roster_public_school2;


--Guaranteed matched International School data

CREATE TABLE roster_international_school1 AS (
	SELECT *
	FROM roster_master_data
	JOIN high_school_data
	ON high_school_data."Public/Private/International" = 'INTERNATIONAL' AND (
		LOWER(roster_master_data.High_School) = LOWER(high_school_data.Institution)
	) AND (
		LOWER(high_school_data.Country) = LOWER(roster_master_data.State_or_Country)
	)
);

DELETE FROM roster_international_school1
USING (
	SELECT Institution, Country, COUNT(Institution)
	FROM high_school_data
	GROUP BY Institution, Country
	HAVING high_school_data.count > 1
) AS temp1
WHERE LOWER(roster_international_school1.Institution) = LOWER(temp1.Institution) AND LOWER(roster_international_school1.Country) = LOWER(temp1.Country)
;

CREATE TABLE roster_international_school2 AS (
	SELECT *
	FROM roster_master_data
	JOIN high_school_data
	ON high_school_data."Public/Private/International" = 'INTERNATIONAL' AND (
		LOWER(roster_master_data.High_School) = LOWER(high_school_data.Institution)
	) AND (
		LOWER(high_school_data.Country) = LOWER(roster_master_data.State_or_Country)
	) AND (
		LOWER(roster_master_data.Home_Town) = LOWER(high_school_data.City)
	)
);

CREATE TABLE roster_international_final AS (
	SELECT *
	FROM roster_international_school1
	UNION
	SELECT *
	FROM
	roster_international_school2
);

-- \Copy roster_international_final to 'roster_international_final.csv' DELIMITER ',' CSV HEADER;

DROP TABLE roster_international_school1;
DROP TABLE roster_international_school2;


-- Unique School Names

CREATE TABLE roster_unique_final AS (
	SELECT *
	FROM roster_master_data
	JOIN high_school_data
	ON LOWER(roster_master_data.High_School) = LOWER(high_school_data.Institution) AND (LOWER(high_school_data."State/Province") = LOWER(roster_master_data.State_or_Country)
	OR LOWER(high_school_data.Country) = LOWER(roster_master_data.State_or_Country))
);

DELETE FROM roster_unique_final
USING (
	SELECT Institution, COUNT(Institution)
	FROM high_school_data
	GROUP BY Institution
	HAVING high_school_data.count > 1
) AS temp1
WHERE LOWER(roster_unique_final.Institution) = LOWER(temp1.Institution)
;

-- \Copy roster_unique_final to 'roster_unique_final.csv' DELIMITER ',' CSV HEADER;


-- Drop old table
DROP TABLE highschool_match_master;


-- Union all tables

CREATE TABLE highschool_match_master AS (
	SELECT *
	FROM roster_unique_final
	UNION
	SELECT *
	FROM (
		SELECT *
		FROM roster_public_final
		UNION
		SELECT *
		FROM roster_international_final
	) AS temp1
);

DROP TABLE roster_public_final;
DROP TABLE roster_international_final;
DROP TABLE roster_unique_final;

\Copy highschool_match_master to 'highschool_match_master.csv' DELIMITER ',' CSV HEADER;
